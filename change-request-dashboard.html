<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Change Request Management - Enhanced</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif; background: transparent; min-height: 100vh; overflow-x: hidden; }
        
        /* Loading */
        .loading { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 9999; justify-content: center; align-items: center; flex-direction: column; }
        .loading.active { display: flex; }
        .spinner { width: 60px; height: 60px; border: 4px solid #f3f3f3; border-top: 4px solid #8B0000; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .loading-text { color: white; margin-top: 20px; font-size: 1.2em; }
        
        /* Login Screen */
        .login-screen { display: flex; justify-content: center; align-items: center; min-height: 100vh; background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%); padding: 20px; }
        .login-screen.hidden { display: none; }
        .login-container { max-width: 500px; width: 100%; }
        .login-header { background: linear-gradient(135deg, #2d2d2d 0%, #1a1a1a 100%); color: white; padding: 40px; border-radius: 16px 16px 0 0; text-align: center; border: 1px solid #3d3d3d; border-bottom: none; }
        .login-header h1 { font-size: 2.5em; margin-bottom: 10px; }
        .login-header .subtitle { color: #b0b0b0; font-size: 1.1em; }
        .login-box { background: #2d2d2d; padding: 40px; border-radius: 0 0 16px 16px; box-shadow: 0 8px 32px rgba(0,0,0,0.3); border: 1px solid #3d3d3d; border-top: none; }
        
        /* App Container */
        .app-container { display: none; background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%); min-height: 100vh; }
        .app-container.active { display: block; }
        
        /* Header */
        .app-header { background: linear-gradient(135deg, #2d2d2d 0%, #1a1a1a 100%); padding: 20px 30px; border-bottom: 2px solid #8B0000; box-shadow: 0 4px 16px rgba(0,0,0,0.3); }
        .header-content { max-width: 1400px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; }
        .header-title { color: #ffffff; font-size: 1.8em; font-weight: 700; }
        .header-user { display: flex; align-items: center; gap: 20px; }
        .user-info { color: #b0b0b0; font-size: 0.9em; }
        .user-name { color: #ffffff; font-weight: 600; }
        .btn-logout { padding: 10px 20px; background: #8B0000; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 0.9em; font-weight: 600; transition: all 0.3s; }
        .btn-logout:hover { background: #B22222; transform: translateY(-2px); }
        
        /* Navigation */
        .nav-container { background: #2d2d2d; border-bottom: 1px solid #3d3d3d; }
        .nav-tabs { max-width: 1400px; margin: 0 auto; display: flex; gap: 0; overflow-x: auto; }
        .nav-tab { padding: 18px 30px; background: transparent; color: #b0b0b0; border: none; border-bottom: 3px solid transparent; cursor: pointer; font-size: 1em; font-weight: 600; transition: all 0.3s; white-space: nowrap; }
        .nav-tab:hover { color: #ffffff; background: rgba(139, 0, 0, 0.1); }
        .nav-tab.active { color: #ffffff; border-bottom-color: #8B0000; background: rgba(139, 0, 0, 0.2); }
        
        /* Main Content */
        .main-content { max-width: 1400px; margin: 0 auto; padding: 30px; }
        
        /* Stats Cards - Phase 1 */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: linear-gradient(135deg, #2d2d2d 0%, #1a1a1a 100%); padding: 25px; border-radius: 12px; border: 1px solid #3d3d3d; box-shadow: 0 4px 16px rgba(0,0,0,0.2); transition: all 0.3s; }
        .stat-card:hover { transform: translateY(-4px); box-shadow: 0 8px 24px rgba(139, 0, 0, 0.3); }
        .stat-icon { font-size: 2.5em; margin-bottom: 10px; }
        .stat-label { color: #b0b0b0; font-size: 0.9em; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 1px; }
        .stat-value { color: #ffffff; font-size: 2.5em; font-weight: 700; }
        .stat-subtitle { color: #7f8c8d; font-size: 0.85em; margin-top: 8px; }
        
        /* Filters Section - Phase 1 */
        .filters-section { background: #2d2d2d; padding: 20px; border-radius: 12px; border: 1px solid #3d3d3d; margin-bottom: 30px; }
        .filters-grid { display: grid; grid-template-columns: 2fr 1fr auto auto; gap: 15px; align-items: end; }
        .filter-group { display: flex; flex-direction: column; }
        .filter-group label { color: #e0e0e0; font-weight: 600; margin-bottom: 8px; font-size: 0.9em; }
        .filter-group input, .filter-group select { padding: 10px; border: 2px solid #3d3d3d; border-radius: 8px; background: #1a1a1a; color: #ffffff; font-size: 0.95em; }
        .filter-group input:focus, .filter-group select:focus { outline: none; border-color: #8B0000; }
        .btn-filter { padding: 11px 20px; background: #8B0000; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s; height: fit-content; }
        .btn-filter:hover { background: #B22222; }
        .btn-clear { padding: 11px 20px; background: #7f8c8d; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; height: fit-content; }
        .btn-clear:hover { background: #6c7a89; }
        
        /* Charts Section - Phase 1 */
        .charts-section { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
        .chart-card { background: #2d2d2d; padding: 25px; border-radius: 12px; border: 1px solid #3d3d3d; }
        .chart-card h3 { color: #ffffff; margin-bottom: 20px; font-size: 1.2em; }
        .chart-container { position: relative; height: 300px; }
        
        @media (max-width: 1200px) {
            .filters-grid { grid-template-columns: 1fr 1fr; }
            .charts-section { grid-template-columns: 1fr; }
        }
        
        @media (max-width: 768px) {
            .stats-grid { grid-template-columns: 1fr; }
            .filters-grid { grid-template-columns: 1fr; }
        }
        
        /* Phase 2 - Heatmap */
        .heatmap-card { background: #2d2d2d; padding: 25px; border-radius: 12px; border: 1px solid #3d3d3d; margin-bottom: 30px; }
        .heatmap-card h3 { color: #ffffff; margin-bottom: 20px; font-size: 1.3em; display: flex; align-items: center; gap: 10px; }
        .heatmap-subtitle { color: #b0b0b0; font-size: 0.85em; margin-bottom: 20px; }
        .heatmap-grid { display: grid; gap: 15px; }
        .heatmap-row { display: grid; grid-template-columns: 150px 1fr 120px; gap: 15px; align-items: center; padding: 15px; background: #1a1a1a; border-radius: 8px; transition: all 0.3s; }
        .heatmap-row:hover { background: #252525; }
        .heatmap-row.clickable { cursor: pointer; }
        .heatmap-label { color: #e0e0e0; font-weight: 600; }
        .heatmap-bar-container { background: #0d0d0d; border-radius: 8px; height: 35px; position: relative; overflow: hidden; }
        .heatmap-bar { height: 100%; border-radius: 8px; transition: width 0.8s; display: flex; align-items: center; padding-left: 10px; color: white; font-weight: 600; font-size: 0.9em; }
        .heatmap-bar.low { background: linear-gradient(90deg, #27ae60, #2ecc71); }
        .heatmap-bar.medium { background: linear-gradient(90deg, #f39c12, #f1c40f); }
        .heatmap-bar.high { background: linear-gradient(90deg, #e74c3c, #c0392b); }
        .heatmap-bar.customer { background: linear-gradient(90deg, #8B0000, #B22222); }
        .heatmap-value { color: #ffffff; font-weight: 700; text-align: right; display: flex; flex-direction: column; }
        .heatmap-value-main { font-size: 1.2em; }
        .heatmap-value-sub { font-size: 0.8em; color: #b0b0b0; }
        
        /* Phase 2 - Customer Modal */
        .customer-stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px; }
        .customer-stat { background: #1a1a1a; padding: 15px; border-radius: 8px; text-align: center; }
        .customer-stat-value { font-size: 2em; color: #8B0000; font-weight: 700; }
        .customer-stat-label { color: #b0b0b0; font-size: 0.9em; margin-top: 5px; }
        .customer-requests-list { max-height: 400px; overflow-y: auto; }
        .customer-request-item { background: #1a1a1a; padding: 15px; border-radius: 8px; margin-bottom: 10px; cursor: pointer; transition: all 0.3s; }
        .customer-request-item:hover { background: #252525; border-left: 4px solid #8B0000; }
        
        /* Form Elements */
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; color: #e0e0e0; font-weight: 600; margin-bottom: 8px; }
        .form-group input, .form-group select { width: 100%; padding: 12px; border: 2px solid #3d3d3d; border-radius: 8px; background: #1a1a1a; color: #ffffff; font-size: 1em; transition: all 0.3s; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: #8B0000; box-shadow: 0 0 0 3px rgba(139, 0, 0, 0.2); }
        
        .btn-primary { width: 100%; padding: 14px; background: linear-gradient(135deg, #8B0000 0%, #B22222 100%); color: white; border: none; border-radius: 8px; font-size: 1.1em; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(139, 0, 0, 0.4); }
        
        .error-message { background: #e74c3c; color: white; padding: 12px; border-radius: 8px; margin-bottom: 20px; display: none; text-align: center; }
        .error-message.show { display: block; }
        
        /* Request Cards */
        .requests-grid { display: grid; gap: 20px; }
        .request-card { background: #2d2d2d; border: 1px solid #3d3d3d; border-radius: 12px; padding: 25px; transition: all 0.3s; cursor: pointer; }
        .request-card:hover { border-color: #8B0000; box-shadow: 0 4px 16px rgba(139, 0, 0, 0.3); transform: translateY(-2px); }
        
        .request-header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #3d3d3d; }
        .request-id { color: #8B0000; font-weight: 700; font-size: 1.2em; }
        .request-date { color: #b0b0b0; font-size: 0.9em; }
        
        .request-info { display: grid; gap: 10px; margin-bottom: 15px; }
        .info-row { display: flex; gap: 10px; }
        .info-label { color: #b0b0b0; min-width: 120px; font-weight: 600; }
        .info-value { color: #ffffff; }
        
        .status-badge { display: inline-block; padding: 6px 12px; border-radius: 6px; font-size: 0.85em; font-weight: 600; }
        .status-submitted { background: #f39c12; color: white; }
        .status-sales { background: #3498db; color: white; }
        .status-design { background: #9b59b6; color: white; }
        .status-shopfloor { background: #e67e22; color: white; }
        .status-service { background: #1abc9c; color: white; }
        .status-complete { background: #27ae60; color: white; }
        .status-rejected { background: #e74c3c; color: white; }
        
        .priority-badge { padding: 4px 8px; border-radius: 4px; font-size: 0.8em; font-weight: 600; }
        .priority-normal { background: #3498db; color: white; }
        .priority-urgent { background: #f39c12; color: white; }
        .priority-critical { background: #e74c3c; color: white; }
        
        .request-actions { display: flex; gap: 10px; margin-top: 15px; padding-top: 15px; border-top: 1px solid #3d3d3d; }
        .btn-approve { flex: 1; padding: 10px; background: #27ae60; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .btn-approve:hover { background: #229954; transform: translateY(-2px); }
        .btn-reject { flex: 1; padding: 10px; background: #e74c3c; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .btn-reject:hover { background: #c0392b; transform: translateY(-2px); }
        
        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center; padding: 20px; }
        .modal.active { display: flex; }
        .modal-content { background: #2d2d2d; border-radius: 16px; max-width: 800px; width: 100%; max-height: 90vh; overflow-y: auto; border: 1px solid #3d3d3d; }
        .modal-header { padding: 25px; border-bottom: 1px solid #3d3d3d; display: flex; justify-content: space-between; align-items: center; }
        .modal-title { color: #ffffff; font-size: 1.5em; font-weight: 700; }
        .modal-close { background: none; border: none; color: #b0b0b0; font-size: 1.5em; cursor: pointer; }
        .modal-close:hover { color: #ffffff; }
        .modal-body { padding: 25px; }
        
        .detail-section { margin-bottom: 25px; }
        .detail-section h3 { color: #8B0000; margin-bottom: 15px; font-size: 1.2em; }
        .detail-grid { display: grid; gap: 15px; }
        .detail-row { display: grid; grid-template-columns: 150px 1fr; gap: 15px; padding: 12px; background: #1a1a1a; border-radius: 8px; }
        .detail-label { color: #b0b0b0; font-weight: 600; }
        .detail-value { color: #ffffff; }
        
        .timeline { position: relative; padding-left: 30px; }
        .timeline-item { position: relative; padding-bottom: 20px; }
        .timeline-item::before { content: ''; position: absolute; left: -22px; top: 8px; width: 12px; height: 12px; border-radius: 50%; background: #8B0000; }
        .timeline-item::after { content: ''; position: absolute; left: -17px; top: 20px; width: 2px; height: calc(100% - 12px); background: #3d3d3d; }
        .timeline-item:last-child::after { display: none; }
        .timeline-stage { color: #8B0000; font-weight: 600; margin-bottom: 5px; }
        .timeline-user { color: #b0b0b0; font-size: 0.9em; }
        .timeline-date { color: #7f8c8d; font-size: 0.85em; }
        .timeline-comments { color: #ffffff; margin-top: 8px; padding: 10px; background: #1a1a1a; border-radius: 6px; }
        
        .comment-box { margin-top: 20px; }
        .comment-box textarea { width: 100%; min-height: 100px; padding: 12px; border: 2px solid #3d3d3d; border-radius: 8px; background: #1a1a1a; color: #ffffff; font-family: inherit; resize: vertical; }
        .comment-box textarea:focus { outline: none; border-color: #8B0000; }
        
        .modal-actions { display: flex; gap: 10px; margin-top: 20px; }
        .btn-modal-approve { flex: 1; padding: 14px; background: #27ae60; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; }
        .btn-modal-approve:hover { background: #229954; }
        .btn-modal-reject { flex: 1; padding: 14px; background: #e74c3c; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; }
        .btn-modal-reject:hover { background: #c0392b; }
        .btn-modal-close { flex: 1; padding: 14px; background: #7f8c8d; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; }
        .btn-modal-close:hover { background: #6c7a89; }
        
        .empty-state { text-align: center; padding: 60px 20px; color: #b0b0b0; }
        .empty-state-icon { font-size: 4em; margin-bottom: 20px; opacity: 0.5; }
        .empty-state-text { font-size: 1.2em; }
        
        /* Toast Notifications */
        .toast-container { position: fixed; top: 20px; right: 20px; z-index: 10000; }
        .toast { background: #2d2d2d; color: white; padding: 16px 24px; border-radius: 8px; margin-bottom: 10px; box-shadow: 0 4px 16px rgba(0,0,0,0.3); border-left: 4px solid #8B0000; animation: slideIn 0.3s; }
        @keyframes slideIn { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .toast.success { border-left-color: #27ae60; }
        .toast.error { border-left-color: #e74c3c; }
        .toast.info { border-left-color: #3498db; }
    </style>
</head>
<body>
    <div class="loading" id="loading">
        <div class="spinner"></div>
        <div class="loading-text">Loading...</div>
    </div>
    
    <div class="toast-container" id="toastContainer"></div>
    
    <!-- Login Screen -->
    <div class="login-screen" id="loginScreen">
        <div class="login-container">
            <div class="login-header">
                <h1>üîß Change Requests</h1>
                <p class="subtitle">Management System</p>
            </div>
            <div class="login-box">
                <div class="error-message" id="loginError"></div>
                <form id="loginForm" onsubmit="return handleLogin(event)">
                    <div class="form-group">
                        <label for="usernameInput">Username</label>
                        <input type="text" id="usernameInput" placeholder="Enter your username" required>
                    </div>
                    <div class="form-group">
                        <label for="pinInput">PIN Code</label>
                        <input type="password" id="pinInput" placeholder="Enter your PIN" required maxlength="4" pattern="[0-9]{4}">
                    </div>
                    <button type="submit" class="btn-primary">Login</button>
                </form>
            </div>
        </div>
    </div>
    
    <!-- App Container -->
    <div class="app-container" id="appContainer">
        <div class="app-header">
            <div class="header-content">
                <div class="header-title">üîß Change Request Management</div>
                <div class="header-user">
                    <div class="user-info">
                        Logged in as: <span class="user-name" id="userName"></span>
                    </div>
                    <button class="btn-logout" onclick="handleLogout()">Logout</button>
                </div>
            </div>
        </div>
        
        <div class="nav-container">
            <div class="nav-tabs" id="navTabs"></div>
        </div>
        
        <div class="main-content" id="mainContent"></div>
    </div>
    
    <!-- Request Detail Modal -->
    <div class="modal" id="requestModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle">Request Details</div>
                <button class="modal-close" onclick="closeModal()">√ó</button>
            </div>
            <div class="modal-body" id="modalBody"></div>
        </div>
    </div>
    
    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbwzdBLg7l2rUL3XezF-We82hh9eTPHN7yMVR6xGkA4LNnOKlZ7w91ddMNKX6IZ2fhbCGg/exec';
        let currentUser = null;
        let currentRequests = [];
        let allRequests = []; // Store unfiltered requests
        let selectedRequest = null;
        let statusChart = null;
        let priorityChart = null;
        let timelineChart = null;
        let departmentChart = null;
        
        // Filter state
        let filters = {
            search: '',
            dateRange: 'all'
        };
        
        function showLoading() { document.getElementById('loading').classList.add('active'); }
        function hideLoading() { document.getElementById('loading').classList.remove('active'); }
        
        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }
        
        async function apiCall(action, params = {}) {
            try {
                const url = new URL(API_URL);
                url.searchParams.append('action', action);
                url.searchParams.append('_t', Date.now());
                Object.keys(params).forEach(key => url.searchParams.append(key, params[key]));
                console.log('API Call:', url.toString());
                const response = await fetch(url.toString());
                if (!response.ok) {
                    console.error('Response not OK:', response.status, response.statusText);
                    throw new Error('Network error: ' + response.status);
                }
                const data = await response.json();
                console.log('API Response:', data);
                return data;
            } catch (error) {
                console.error('API Call Error:', error);
                throw error;
            }
        }
        
        async function handleLogin(event) {
            event.preventDefault();
            const username = document.getElementById('usernameInput').value;
            const pin = document.getElementById('pinInput').value;
            const errorDiv = document.getElementById('loginError');
            errorDiv.classList.remove('show');
            
            showLoading();
            try {
                const response = await apiCall('login', { username, pin });
                if (response.success) {
                    currentUser = response.data;
                    showApp();
                } else {
                    errorDiv.textContent = response.message || 'Invalid credentials';
                    errorDiv.classList.add('show');
                }
            } catch (error) {
                errorDiv.textContent = 'Connection error. Check internet and try again.';
                errorDiv.classList.add('show');
            } finally {
                hideLoading();
            }
            return false;
        }
        
        function showApp() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('appContainer').classList.add('active');
            document.getElementById('userName').textContent = currentUser.username;
            setupNavigation();
            loadDefaultView();
        }
        
        function setupNavigation() {
            const navTabs = document.getElementById('navTabs');
            navTabs.innerHTML = '';
            
            let tabs = [];
            if (currentUser.role === 'Sales Rep') {
                tabs = [
                    { id: 'myRequests', label: 'üìù My Requests' }
                ];
            } else if (currentUser.role === 'Management') {
                tabs = [
                    { id: 'allRequests', label: 'üìä All Requests' },
                    { id: 'pendingApprovals', label: '‚è≥ Pending Approvals' }
                ];
            } else {
                tabs = [
                    { id: 'pendingApprovals', label: '‚è≥ Pending Approvals' },
                    { id: 'myRequests', label: 'üìù My Requests' }
                ];
            }
            
            tabs.forEach((tab, index) => {
                const button = document.createElement('button');
                button.className = 'nav-tab' + (index === 0 ? ' active' : '');
                button.textContent = tab.label;
                button.onclick = () => switchTab(tab.id, button);
                navTabs.appendChild(button);
            });
        }
        
        function switchTab(tabId, button) {
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            button.classList.add('active');
            
            switch(tabId) {
                case 'myRequests': loadMyRequests(); break;
                case 'pendingApprovals': loadPendingApprovals(); break;
                case 'allRequests': loadAllRequests(); break;
            }
        }
        
        function loadDefaultView() {
            if (currentUser.role === 'Sales Rep') {
                loadMyRequests();
            } else if (currentUser.role === 'Management') {
                loadAllRequests();
            } else {
                loadPendingApprovals();
            }
        }
        
        async function loadMyRequests() {
            showLoading();
            try {
                const response = await apiCall('getMyRequests', { username: currentUser.username });
                if (response.success) {
                    renderRequests(response.data, 'my');
                }
            } catch (error) {
                showToast('Error loading requests', 'error');
            } finally {
                hideLoading();
            }
        }
        
        async function loadPendingApprovals() {
            showLoading();
            try {
                const response = await apiCall('getPendingApprovals', { department: currentUser.department });
                if (response.success) {
                    renderRequests(response.data, 'pending');
                }
            } catch (error) {
                showToast('Error loading approvals', 'error');
            } finally {
                hideLoading();
            }
        }
        
        async function loadAllRequests() {
            showLoading();
            try {
                const response = await apiCall('getAllRequests');
                if (response.success) {
                    renderRequests(response.data, 'all');
                }
            } catch (error) {
                showToast('Error loading requests', 'error');
            } finally {
                hideLoading();
            }
        }
        
        function renderRequests(requests, viewType) {
            // Phase 1 Enhancement - use enhanced rendering
            renderRequestsEnhanced(requests, viewType);
        }
        
        // PHASE 1 ENHANCED FUNCTIONS
        function renderRequestsEnhanced(requests, viewType) {
            allRequests = requests;
            currentRequests = requests;
            applyFilters(viewType);
        }
        
        function applyFilters(viewType) {
            let filtered = [...allRequests];
            
            if (filters.search) {
                const searchLower = filters.search.toLowerCase();
                filtered = filtered.filter(req => 
                    req.requestID.toLowerCase().includes(searchLower) ||
                    req.customerName.toLowerCase().includes(searchLower) ||
                    req.truckModel.toLowerCase().includes(searchLower) ||
                    (req.submittedBy && req.submittedBy.toLowerCase().includes(searchLower))
                );
            }
            
            if (filters.dateRange !== 'all') {
                const now = new Date();
                let startDate;
                
                switch(filters.dateRange) {
                    case 'today':
                        startDate = new Date(now.setHours(0,0,0,0));
                        break;
                    case 'week':
                        startDate = new Date(now.setDate(now.getDate() - 7));
                        break;
                    case 'month':
                        startDate = new Date(now.setMonth(now.getMonth() - 1));
                        break;
                }
                
                filtered = filtered.filter(req => new Date(req.dateSubmitted) >= startDate);
            }
            
            currentRequests = filtered;
            renderDashboard(filtered, viewType);
        }
        
        function renderDashboard(requests, viewType) {
            const content = document.getElementById('mainContent');
            
            let html = buildStatsCards(requests) + buildFiltersSection() + buildChartsSection();
            
            if (requests.length === 0) {
                html += '<div class="empty-state"><div class="empty-state-icon">üìã</div><div class="empty-state-text">No requests found</div></div>';
            } else {
                html += '<div class="requests-grid">';
                requests.forEach(req => {
                    const statusClass = getStatusClass(req.status);
                    const priorityClass = getPriorityClass(req.priority);
                    
                    html += `
                        <div class="request-card" onclick="viewRequestDetails('${req.requestID}')">
                            <div class="request-header">
                                <div>
                                    <div class="request-id">${req.requestID}</div>
                                    <div class="request-date">${formatDate(req.dateSubmitted)}</div>
                                </div>
                                <span class="status-badge ${statusClass}">${req.currentStage}</span>
                            </div>
                            <div class="request-info">
                                <div class="info-row">
                                    <span class="info-label">Customer:</span>
                                    <span class="info-value">${req.customerName}</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">Truck Model:</span>
                                    <span class="info-value">${req.truckModel}</span>
                                </div>
                                ${viewType !== 'my' ? `
                                <div class="info-row">
                                    <span class="info-label">Submitted By:</span>
                                    <span class="info-value">${req.submittedBy}</span>
                                </div>
                                ` : ''}
                                <div class="info-row">
                                    <span class="info-label">Priority:</span>
                                    <span class="priority-badge ${priorityClass}">${req.priority}</span>
                                </div>
                            </div>
                            ${viewType === 'pending' ? `
                            <div class="request-actions">
                                <button class="btn-approve" onclick="event.stopPropagation(); approveRequest('${req.requestID}')">‚úì Approve</button>
                                <button class="btn-reject" onclick="event.stopPropagation(); rejectRequest('${req.requestID}')">‚úï Reject</button>
                            </div>
                            ` : ''}
                        </div>
                    `;
                });
                html += '</div>';
            }
            
            content.innerHTML = html;
            setTimeout(() => { initializeCharts(requests); attachFilterListeners(); }, 100);
        }
        
        function buildStatsCards(requests) {
            const total = requests.length;
            const pending = requests.filter(r => !r.currentStage.includes('Complete') && !r.currentStage.includes('Rejected')).length;
            const complete = requests.filter(r => r.currentStage.includes('Complete')).length;
            const rejected = requests.filter(r => r.currentStage.includes('Rejected')).length;
            
            return `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">üìä</div>
                        <div class="stat-label">Total Requests</div>
                        <div class="stat-value">${total}</div>
                        <div class="stat-subtitle">All time</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">‚è≥</div>
                        <div class="stat-label">In Progress</div>
                        <div class="stat-value">${pending}</div>
                        <div class="stat-subtitle">Awaiting approval</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">‚úÖ</div>
                        <div class="stat-label">Completed</div>
                        <div class="stat-value">${complete}</div>
                        <div class="stat-subtitle">${total > 0 ? Math.round((complete/total)*100) : 0}% completion rate</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">‚ùå</div>
                        <div class="stat-label">Rejected</div>
                        <div class="stat-value">${rejected}</div>
                        <div class="stat-subtitle">${total > 0 ? Math.round((rejected/total)*100) : 0}% rejection rate</div>
                    </div>
                </div>
            `;
        }
        
        function buildFiltersSection() {
            return `
                <div class="filters-section">
                    <div class="filters-grid">
                        <div class="filter-group">
                            <label>üîç Search</label>
                            <input type="text" id="searchInput" placeholder="Search by customer, ID, truck model..." value="${filters.search}">
                        </div>
                        <div class="filter-group">
                            <label>üìÖ Date Range</label>
                            <select id="dateRangeSelect">
                                <option value="all" ${filters.dateRange === 'all' ? 'selected' : ''}>All Time</option>
                                <option value="today" ${filters.dateRange === 'today' ? 'selected' : ''}>Today</option>
                                <option value="week" ${filters.dateRange === 'week' ? 'selected' : ''}>This Week</option>
                                <option value="month" ${filters.dateRange === 'month' ? 'selected' : ''}>This Month</option>
                            </select>
                        </div>
                        <button class="btn-filter" onclick="handleFilterApply()">Apply</button>
                        <button class="btn-clear" onclick="handleFilterClear()">Clear</button>
                    </div>
                </div>
            `;
        }
        
        function buildChartsSection() {
            return `
                ${buildHeatmap()}
                <div class="charts-section">
                    <div class="chart-card">
                        <h3>üìä Requests by Status</h3>
                        <div class="chart-container">
                            <canvas id="statusChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <h3>‚ö° Requests by Priority</h3>
                        <div class="chart-container">
                            <canvas id="priorityChart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="charts-section">
                    <div class="chart-card">
                        <h3>üìà Requests Timeline</h3>
                        <div class="chart-container">
                            <canvas id="timelineChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <h3>üè¢ Department Workload</h3>
                        <div class="chart-container">
                            <canvas id="departmentChart"></canvas>
                        </div>
                    </div>
                </div>
                ${buildTopCustomers()}
            `;
        }
        
        function buildHeatmap() {
            const deptData = calculateDepartmentMetrics(allRequests);
            const maxAvgTime = Math.max(...deptData.map(d => d.avgTime), 1);
            
            return `
                <div class="heatmap-card">
                    <h3>üî• Department Performance Analysis</h3>
                    <div class="heatmap-subtitle">Average processing time and current workload by department</div>
                    <div class="heatmap-grid">
                        ${deptData.map(dept => {
                            const percentage = (dept.avgTime / maxAvgTime) * 100;
                            const barClass = dept.avgTime > 2 ? 'high' : dept.avgTime > 1 ? 'medium' : 'low';
                            return `
                                <div class="heatmap-row">
                                    <div class="heatmap-label">${dept.name}</div>
                                    <div class="heatmap-bar-container">
                                        <div class="heatmap-bar ${barClass}" style="width: ${percentage}%">
                                            ${dept.avgTime.toFixed(1)} days avg
                                        </div>
                                    </div>
                                    <div class="heatmap-value">
                                        <span class="heatmap-value-main">${dept.pending}</span>
                                        <span class="heatmap-value-sub">pending</span>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }
        
        function calculateDepartmentMetrics(requests) {
            const departments = ['Sales', 'Design', 'Shop Floor', 'Service'];
            return departments.map(dept => {
                const deptRequests = requests.filter(r => {
                    if (dept === 'Sales') return r.currentStage.includes('Sales');
                    if (dept === 'Design') return r.currentStage.includes('Design');
                    if (dept === 'Shop Floor') return r.currentStage.includes('Shop');
                    if (dept === 'Service') return r.currentStage.includes('Service');
                    return false;
                });
                
                const pending = deptRequests.length;
                let avgTime = 0;
                if (pending > 0) {
                    const now = new Date();
                    const totalDays = deptRequests.reduce((sum, req) => {
                        const submitted = new Date(req.dateSubmitted);
                        const days = (now - submitted) / (1000 * 60 * 60 * 24);
                        return sum + days;
                    }, 0);
                    avgTime = totalDays / pending;
                }
                
                return { name: dept, pending, avgTime };
            });
        }
        
        function buildTopCustomers() {
            const customerCounts = {};
            allRequests.forEach(req => {
                customerCounts[req.customerName] = (customerCounts[req.customerName] || 0) + 1;
            });
            
            const topCustomers = Object.entries(customerCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);
            
            if (topCustomers.length === 0) return '';
            
            return `
                <div class="heatmap-card">
                    <h3>‚≠ê Top Customers</h3>
                    <div class="heatmap-subtitle">Customers with most change requests - click to view history</div>
                    <div class="heatmap-grid">
                        ${topCustomers.map(([customer, count]) => {
                            const maxCount = topCustomers[0][1];
                            const percentage = (count / maxCount) * 100;
                            return `
                                <div class="heatmap-row clickable" onclick="viewCustomerHistory('${customer.replace(/'/g, "\\'")}')">
                                    <div class="heatmap-label">${customer}</div>
                                    <div class="heatmap-bar-container">
                                        <div class="heatmap-bar customer" style="width: ${percentage}%">
                                            ${count} request${count > 1 ? 's' : ''}
                                        </div>
                                    </div>
                                    <div class="heatmap-value">
                                        <span class="heatmap-value-main">üëÅÔ∏è</span>
                                        <span class="heatmap-value-sub">view</span>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }
        
        function initializeCharts(requests) {
            if (statusChart) statusChart.destroy();
            if (priorityChart) priorityChart.destroy();
            if (timelineChart) timelineChart.destroy();
            if (departmentChart) departmentChart.destroy();
            
            const statusCounts = { 'Sales Review': 0, 'Design Review': 0, 'Shop Floor': 0, 'Service Install': 0, 'Complete': 0, 'Rejected': 0 };
            requests.forEach(req => {
                if (req.currentStage.includes('Sales')) statusCounts['Sales Review']++;
                else if (req.currentStage.includes('Design')) statusCounts['Design Review']++;
                else if (req.currentStage.includes('Shop')) statusCounts['Shop Floor']++;
                else if (req.currentStage.includes('Service')) statusCounts['Service Install']++;
                else if (req.currentStage.includes('Complete')) statusCounts['Complete']++;
                else if (req.currentStage.includes('Rejected')) statusCounts['Rejected']++;
            });
            
            const statusCtx = document.getElementById('statusChart');
            if (statusCtx) {
                statusChart = new Chart(statusCtx, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(statusCounts),
                        datasets: [{ data: Object.values(statusCounts), backgroundColor: ['#3498db', '#9b59b6', '#e67e22', '#1abc9c', '#27ae60', '#e74c3c'], borderWidth: 2, borderColor: '#1a1a1a' }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { labels: { color: '#ffffff', font: { size: 12 } } } } }
                });
            }
            
            const priorityCounts = { 'Normal': 0, 'Urgent': 0, 'Critical': 0 };
            requests.forEach(req => { if (priorityCounts[req.priority] !== undefined) priorityCounts[req.priority]++; });
            
            const priorityCtx = document.getElementById('priorityChart');
            if (priorityCtx) {
                priorityChart = new Chart(priorityCtx, {
                    type: 'bar',
                    data: {
                        labels: Object.keys(priorityCounts),
                        datasets: [{ label: 'Requests', data: Object.values(priorityCounts), backgroundColor: ['#3498db', '#f39c12', '#e74c3c'], borderWidth: 0 }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { color: '#ffffff', stepSize: 1 }, grid: { color: '#3d3d3d' } }, x: { ticks: { color: '#ffffff' }, grid: { display: false } } }, plugins: { legend: { display: false } } }
                });
            }
            
            // Timeline Chart
            const timelineData = generateTimelineData(requests);
            const timelineCtx = document.getElementById('timelineChart');
            if (timelineCtx) {
                timelineChart = new Chart(timelineCtx, {
                    type: 'line',
                    data: {
                        labels: timelineData.labels,
                        datasets: [{
                            label: 'Requests Submitted',
                            data: timelineData.data,
                            borderColor: '#8B0000',
                            backgroundColor: 'rgba(139, 0, 0, 0.1)',
                            tension: 0.4,
                            fill: true,
                            pointRadius: 4,
                            pointHoverRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: { beginAtZero: true, ticks: { color: '#ffffff', stepSize: 1 }, grid: { color: '#3d3d3d' } },
                            x: { ticks: { color: '#ffffff' }, grid: { color: '#3d3d3d' } }
                        },
                        plugins: { legend: { labels: { color: '#ffffff' } } }
                    }
                });
            }
            
            // Department Workload Chart
            const deptData = calculateDepartmentMetrics(requests);
            const departmentCtx = document.getElementById('departmentChart');
            if (departmentCtx) {
                departmentChart = new Chart(departmentCtx, {
                    type: 'bar',
                    data: {
                        labels: deptData.map(d => d.name),
                        datasets: [{
                            label: 'Pending Requests',
                            data: deptData.map(d => d.pending),
                            backgroundColor: ['#3498db', '#9b59b6', '#e67e22', '#1abc9c'],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: { beginAtZero: true, ticks: { color: '#ffffff', stepSize: 1 }, grid: { color: '#3d3d3d' } },
                            y: { ticks: { color: '#ffffff' }, grid: { display: false } }
                        },
                        plugins: { legend: { display: false } }
                    }
                });
            }
        }
        
        function generateTimelineData(requests) {
            const weeks = {};
            const now = new Date();
            
            for (let i = 7; i >= 0; i--) {
                const weekStart = new Date(now);
                weekStart.setDate(weekStart.getDate() - (i * 7));
                const weekLabel = `Week ${8-i}`;
                weeks[weekLabel] = 0;
            }
            
            requests.forEach(req => {
                const reqDate = new Date(req.dateSubmitted);
                const daysDiff = Math.floor((now - reqDate) / (1000 * 60 * 60 * 24));
                const weekIndex = Math.min(7, Math.floor(daysDiff / 7));
                const weekLabel = `Week ${8 - weekIndex}`;
                if (weeks[weekLabel] !== undefined) weeks[weekLabel]++;
            });
            
            return { labels: Object.keys(weeks), data: Object.values(weeks) };
        }
        
        function attachFilterListeners() {
            const searchInput = document.getElementById('searchInput');
            if (searchInput) { searchInput.addEventListener('keyup', (e) => { if (e.key === 'Enter') handleFilterApply(); }); }
        }
        
        function handleFilterApply() {
            const searchInput = document.getElementById('searchInput');
            const dateRangeSelect = document.getElementById('dateRangeSelect');
            if (searchInput) filters.search = searchInput.value;
            if (dateRangeSelect) filters.dateRange = dateRangeSelect.value;
            let viewType = 'my';
            const activeTab = document.querySelector('.nav-tab.active');
            if (activeTab) {
                if (activeTab.textContent.includes('All')) viewType = 'all';
                else if (activeTab.textContent.includes('Pending')) viewType = 'pending';
            }
            applyFilters(viewType);
            showToast('Filters applied!', 'success');
        }
        
        function handleFilterClear() {
            filters = { search: '', dateRange: 'all' };
            let viewType = 'my';
            const activeTab = document.querySelector('.nav-tab.active');
            if (activeTab) {
                if (activeTab.textContent.includes('All')) viewType = 'all';
                else if (activeTab.textContent.includes('Pending')) viewType = 'pending';
            }
            applyFilters(viewType);
            showToast('Filters cleared', 'info');
        }
        
        async function viewRequestDetails(requestID) {
            showLoading();
            try {
                const response = await apiCall('getRequestDetails', { requestID });
                if (response.success) {
                    selectedRequest = response.data;
                    showRequestModal();
                }
            } catch (error) {
                showToast('Error loading details', 'error');
            } finally {
                hideLoading();
            }
        }
        
        function showRequestModal() {
            const req = selectedRequest;
            const modal = document.getElementById('requestModal');
            const modalBody = document.getElementById('modalBody');
            
            document.getElementById('modalTitle').textContent = req.requestID;
            
            let html = `
                <div class="detail-section">
                    <h3>Customer Information</h3>
                    <div class="detail-grid">
                        <div class="detail-row">
 
