<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Change Request Management - Phase 2</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif; background: transparent; min-height: 100vh; overflow-x: hidden; }
        
        /* Loading */
        .loading { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 9999; justify-content: center; align-items: center; flex-direction: column; }
        .loading.active { display: flex; }
        .spinner { width: 60px; height: 60px; border: 4px solid #f3f3f3; border-top: 4px solid #8B0000; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .loading-text { color: white; margin-top: 20px; font-size: 1.2em; }
        
        /* Login Screen */
        .login-screen { display: flex; justify-content: center; align-items: center; min-height: 100vh; background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%); padding: 20px; }
        .login-screen.hidden { display: none; }
        .login-container { max-width: 500px; width: 100%; }
        .login-header { background: linear-gradient(135deg, #2d2d2d 0%, #1a1a1a 100%); color: white; padding: 40px; border-radius: 16px 16px 0 0; text-align: center; border: 1px solid #3d3d3d; border-bottom: none; }
        .login-header h1 { font-size: 2.5em; margin-bottom: 10px; }
        .login-header .subtitle { color: #b0b0b0; font-size: 1.1em; }
        .login-box { background: #2d2d2d; padding: 40px; border-radius: 0 0 16px 16px; box-shadow: 0 8px 32px rgba(0,0,0,0.3); border: 1px solid #3d3d3d; border-top: none; }
        
        /* App Container */
        .app-container { display: none; background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%); min-height: 100vh; }
        .app-container.active { display: block; }
        
        /* Header */
        .app-header { background: linear-gradient(135deg, #2d2d2d 0%, #1a1a1a 100%); padding: 20px 30px; border-bottom: 2px solid #8B0000; box-shadow: 0 4px 16px rgba(0,0,0,0.3); }
        .header-content { max-width: 1400px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; }
        .header-title { color: #ffffff; font-size: 1.8em; font-weight: 700; }
        .header-user { display: flex; align-items: center; gap: 20px; }
        .user-info { color: #b0b0b0; font-size: 0.9em; }
        .user-name { color: #ffffff; font-weight: 600; }
        .btn-logout { padding: 10px 20px; background: #8B0000; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 0.9em; font-weight: 600; transition: all 0.3s; }
        .btn-logout:hover { background: #B22222; transform: translateY(-2px); }
        
        /* Navigation */
        .nav-container { background: #2d2d2d; border-bottom: 1px solid #3d3d3d; }
        .nav-tabs { max-width: 1400px; margin: 0 auto; display: flex; gap: 0; overflow-x: auto; }
        .nav-tab { padding: 18px 30px; background: transparent; color: #b0b0b0; border: none; border-bottom: 3px solid transparent; cursor: pointer; font-size: 1em; font-weight: 600; transition: all 0.3s; white-space: nowrap; }
        .nav-tab:hover { color: #ffffff; background: rgba(139, 0, 0, 0.1); }
        .nav-tab.active { color: #ffffff; border-bottom-color: #8B0000; background: rgba(139, 0, 0, 0.2); }
        
        /* Main Content */
        .main-content { max-width: 1400px; margin: 0 auto; padding: 30px; }
        
        /* Stats Cards */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: linear-gradient(135deg, #2d2d2d 0%, #1a1a1a 100%); padding: 25px; border-radius: 12px; border: 1px solid #3d3d3d; box-shadow: 0 4px 16px rgba(0,0,0,0.2); transition: all 0.3s; }
        .stat-card:hover { transform: translateY(-4px); box-shadow: 0 8px 24px rgba(139, 0, 0, 0.3); }
        .stat-icon { font-size: 2.5em; margin-bottom: 10px; }
        .stat-label { color: #b0b0b0; font-size: 0.9em; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 1px; }
        .stat-value { color: #ffffff; font-size: 2.5em; font-weight: 700; }
        .stat-subtitle { color: #7f8c8d; font-size: 0.85em; margin-top: 8px; }
        
        /* Filters Section */
        .filters-section { background: #2d2d2d; padding: 20px; border-radius: 12px; border: 1px solid #3d3d3d; margin-bottom: 30px; }
        .filters-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .filters-title { color: #ffffff; font-size: 1.2em; font-weight: 600; }
        .btn-advanced-search { padding: 8px 16px; background: #8B0000; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9em; font-weight: 600; transition: all 0.3s; }
        .btn-advanced-search:hover { background: #B22222; }
        .filters-grid { display: grid; grid-template-columns: 2fr 1fr auto auto; gap: 15px; align-items: end; }
        .filter-group { display: flex; flex-direction: column; }
        .filter-group label { color: #e0e0e0; font-weight: 600; margin-bottom: 8px; font-size: 0.9em; }
        .filter-group input, .filter-group select { padding: 10px; border: 2px solid #3d3d3d; border-radius: 8px; background: #1a1a1a; color: #ffffff; font-size: 0.95em; }
        .filter-group input:focus, .filter-group select:focus { outline: none; border-color: #8B0000; }
        .btn-filter { padding: 11px 20px; background: #8B0000; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s; height: fit-content; }
        .btn-filter:hover { background: #B22222; }
        .btn-clear { padding: 11px 20px; background: #7f8c8d; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; height: fit-content; }
        .btn-clear:hover { background: #6c7a89; }
        
        /* Advanced Search Modal */
        .advanced-search-panel { display: none; margin-top: 15px; padding: 20px; background: #1a1a1a; border-radius: 8px; border: 1px solid #3d3d3d; }
        .advanced-search-panel.active { display: block; }
        .advanced-search-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        
        /* Charts Section */
        .charts-section { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
        .chart-card { background: #2d2d2d; padding: 25px; border-radius: 12px; border: 1px solid #3d3d3d; }
        .chart-card h3 { color: #ffffff; margin-bottom: 20px; font-size: 1.2em; }
        .chart-container { position: relative; height: 300px; }
        
        /* Analytics Dashboard */
        .analytics-section { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 30px; }
        .analytics-card { background: #2d2d2d; padding: 25px; border-radius: 12px; border: 1px solid #3d3d3d; }
        .analytics-card h4 { color: #8B0000; margin-bottom: 15px; font-size: 1em; }
        .metric-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #3d3d3d; }
        .metric-row:last-child { border-bottom: none; }
        .metric-label { color: #b0b0b0; font-size: 0.9em; }
        .metric-value { color: #ffffff; font-weight: 600; }
        
        @media (max-width: 1200px) {
            .filters-grid { grid-template-columns: 1fr 1fr; }
            .charts-section { grid-template-columns: 1fr; }
            .analytics-section { grid-template-columns: 1fr 1fr; }
        }
        
        @media (max-width: 768px) {
            .stats-grid { grid-template-columns: 1fr; }
            .filters-grid { grid-template-columns: 1fr; }
            .advanced-search-grid { grid-template-columns: 1fr; }
            .analytics-section { grid-template-columns: 1fr; }
        }
        
        /* Form Elements */
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; color: #e0e0e0; font-weight: 600; margin-bottom: 8px; }
        .form-group input, .form-group select { width: 100%; padding: 12px; border: 2px solid #3d3d3d; border-radius: 8px; background: #1a1a1a; color: #ffffff; font-size: 1em; transition: all 0.3s; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: #8B0000; box-shadow: 0 0 0 3px rgba(139, 0, 0, 0.2); }
        
        .btn-primary { width: 100%; padding: 14px; background: linear-gradient(135deg, #8B0000 0%, #B22222 100%); color: white; border: none; border-radius: 8px; font-size: 1.1em; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(139, 0, 0, 0.4); }
        
        .error-message { background: #e74c3c; color: white; padding: 12px; border-radius: 8px; margin-bottom: 20px; display: none; text-align: center; }
        .error-message.show { display: block; }
        
        /* Request Cards */
        .requests-grid { display: grid; gap: 20px; }
        .request-card { background: #2d2d2d; border: 1px solid #3d3d3d; border-radius: 12px; padding: 25px; transition: all 0.3s; cursor: pointer; position: relative; }
        .request-card:hover { border-color: #8B0000; box-shadow: 0 4px 16px rgba(139, 0, 0, 0.3); transform: translateY(-2px); }
        
        .unread-badge { position: absolute; top: 15px; right: 15px; background: #e74c3c; color: white; padding: 4px 10px; border-radius: 12px; font-size: 0.75em; font-weight: 600; }
        
        .request-header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #3d3d3d; }
        .request-id { color: #8B0000; font-weight: 700; font-size: 1.2em; }
        .request-date { color: #b0b0b0; font-size: 0.9em; }
        
        .request-info { display: grid; gap: 10px; margin-bottom: 15px; }
        .info-row { display: flex; gap: 10px; }
        .info-label { color: #b0b0b0; min-width: 120px; font-weight: 600; }
        .info-value { color: #ffffff; }
        
        .status-badge { display: inline-block; padding: 6px 12px; border-radius: 6px; font-size: 0.85em; font-weight: 600; }
        .status-submitted { background: #f39c12; color: white; }
        .status-sales { background: #3498db; color: white; }
        .status-design { background: #9b59b6; color: white; }
        .status-shopfloor { background: #e67e22; color: white; }
        .status-service { background: #1abc9c; color: white; }
        .status-complete { background: #27ae60; color: white; }
        .status-rejected { background: #e74c3c; color: white; }
        
        .priority-badge { padding: 4px 8px; border-radius: 4px; font-size: 0.8em; font-weight: 600; }
        .priority-normal { background: #3498db; color: white; }
        .priority-urgent { background: #f39c12; color: white; }
        .priority-critical { background: #e74c3c; color: white; }
        
        .request-actions { display: flex; gap: 10px; margin-top: 15px; padding-top: 15px; border-top: 1px solid #3d3d3d; }
        .btn-approve { flex: 1; padding: 10px; background: #27ae60; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .btn-approve:hover { background: #229954; transform: translateY(-2px); }
        .btn-reject { flex: 1; padding: 10px; background: #e74c3c; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .btn-reject:hover { background: #c0392b; transform: translateY(-2px); }
        
        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center; padding: 20px; overflow-y: auto; }
        .modal.active { display: flex; }
        .modal-content { background: #2d2d2d; border-radius: 16px; max-width: 900px; width: 100%; max-height: 90vh; overflow-y: auto; border: 1px solid #3d3d3d; margin: auto; }
        .modal-header { padding: 25px; border-bottom: 1px solid #3d3d3d; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; background: #2d2d2d; z-index: 10; }
        .modal-title { color: #ffffff; font-size: 1.5em; font-weight: 700; }
        .modal-close { background: none; border: none; color: #b0b0b0; font-size: 1.5em; cursor: pointer; }
        .modal-close:hover { color: #ffffff; }
        .modal-body { padding: 25px; }
        
        .detail-section { margin-bottom: 25px; }
        .detail-section h3 { color: #8B0000; margin-bottom: 15px; font-size: 1.2em; }
        .detail-grid { display: grid; gap: 15px; }
        .detail-row { display: grid; grid-template-columns: 150px 1fr; gap: 15px; padding: 12px; background: #1a1a1a; border-radius: 8px; }
        .detail-label { color: #b0b0b0; font-weight: 600; }
        .detail-value { color: #ffffff; }
        
        .timeline { position: relative; padding-left: 30px; }
        .timeline-item { position: relative; padding-bottom: 20px; }
        .timeline-item::before { content: ''; position: absolute; left: -22px; top: 8px; width: 12px; height: 12px; border-radius: 50%; background: #8B0000; }
        .timeline-item::after { content: ''; position: absolute; left: -17px; top: 20px; width: 2px; height: calc(100% - 12px); background: #3d3d3d; }
        .timeline-item:last-child::after { display: none; }
        .timeline-stage { color: #8B0000; font-weight: 600; margin-bottom: 5px; }
        .timeline-user { color: #b0b0b0; font-size: 0.9em; }
        .timeline-date { color: #7f8c8d; font-size: 0.85em; }
        .timeline-comments { color: #ffffff; margin-top: 8px; padding: 10px; background: #1a1a1a; border-radius: 6px; }
        
        /* PHASE 2: Comments Section */
        .comments-section { margin-top: 30px; padding-top: 25px; border-top: 2px solid #3d3d3d; }
        .comments-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .comments-title { color: #ffffff; font-size: 1.2em; font-weight: 600; }
        .comments-count { color: #b0b0b0; font-size: 0.9em; }
        
        .comment-thread { max-height: 400px; overflow-y: auto; margin-bottom: 20px; }
        .comment-item { background: #1a1a1a; padding: 15px; border-radius: 8px; margin-bottom: 12px; border-left: 3px solid #8B0000; }
        .comment-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .comment-user { color: #8B0000; font-weight: 600; font-size: 0.95em; }
        .comment-time { color: #7f8c8d; font-size: 0.8em; }
        .comment-edited { color: #f39c12; font-size: 0.75em; margin-left: 8px; }
        .comment-text { color: #ffffff; line-height: 1.6; white-space: pre-wrap; }
        .comment-mention { color: #3498db; font-weight: 600; }
        .comment-actions { display: flex; gap: 10px; margin-top: 10px; }
        .btn-comment-action { padding: 4px 10px; background: transparent; color: #b0b0b0; border: 1px solid #3d3d3d; border-radius: 4px; cursor: pointer; font-size: 0.8em; transition: all 0.3s; }
        .btn-comment-action:hover { color: #ffffff; border-color: #8B0000; }
        
        .comment-input-box { position: relative; }
        .comment-input { width: 100%; min-height: 80px; padding: 12px; border: 2px solid #3d3d3d; border-radius: 8px; background: #1a1a1a; color: #ffffff; font-family: inherit; resize: vertical; }
        .comment-input:focus { outline: none; border-color: #8B0000; }
        .mention-dropdown { position: absolute; background: #1a1a1a; border: 1px solid #3d3d3d; border-radius: 8px; max-height: 200px; overflow-y: auto; z-index: 100; display: none; box-shadow: 0 4px 16px rgba(0,0,0,0.5); }
        .mention-dropdown.active { display: block; }
        .mention-item { padding: 10px 15px; cursor: pointer; transition: all 0.3s; }
        .mention-item:hover, .mention-item.selected { background: #8B0000; }
        .mention-name { color: #ffffff; font-weight: 600; }
        .mention-dept { color: #b0b0b0; font-size: 0.85em; }
        
        .btn-add-comment { width: 100%; padding: 12px; background: #8B0000; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; margin-top: 10px; transition: all 0.3s; }
        .btn-add-comment:hover { background: #B22222; }
        
        /* PHASE 2: Attachments Section */
        .attachments-section { margin-top: 25px; padding-top: 20px; border-top: 1px solid #3d3d3d; }
        .attachments-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .attachments-title { color: #ffffff; font-size: 1.1em; font-weight: 600; }
        .btn-upload-file { padding: 8px 16px; background: #8B0000; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9em; font-weight: 600; transition: all 0.3s; }
        .btn-upload-file:hover { background: #B22222; }
        
        .attachments-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 15px; }
        .attachment-item { background: #1a1a1a; padding: 12px; border-radius: 8px; text-align: center; cursor: pointer; transition: all 0.3s; border: 2px solid transparent; }
        .attachment-item:hover { border-color: #8B0000; transform: translateY(-2px); }
        .attachment-icon { font-size: 2.5em; margin-bottom: 8px; }
        .attachment-name { color: #ffffff; font-size: 0.85em; word-wrap: break-word; margin-bottom: 5px; }
        .attachment-meta { color: #7f8c8d; font-size: 0.75em; }
        .attachment-image { width: 100%; height: 80px; object-fit: cover; border-radius: 6px; margin-bottom: 8px; }
        
        .file-input-hidden { display: none; }
        
        .modal-actions { display: flex; gap: 10px; margin-top: 20px; }
        .btn-modal-approve { flex: 1; padding: 14px; background: #27ae60; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; }
        .btn-modal-approve:hover { background: #229954; }
        .btn-modal-reject { flex: 1; padding: 14px; background: #e74c3c; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; }
        .btn-modal-reject:hover { background: #c0392b; }
        .btn-modal-close { flex: 1; padding: 14px; background: #7f8c8d; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; }
        .btn-modal-close:hover { background: #6c7a89; }
        
        .empty-state { text-align: center; padding: 60px 20px; color: #b0b0b0; }
        .empty-state-icon { font-size: 4em; margin-bottom: 20px; opacity: 0.5; }
        .empty-state-text { font-size: 1.2em; }
        
        /* Toast Notifications */
        .toast-container { position: fixed; top: 20px; right: 20px; z-index: 10000; }
        .toast { background: #2d2d2d; color: white; padding: 16px 24px; border-radius: 8px; margin-bottom: 10px; box-shadow: 0 4px 16px rgba(0,0,0,0.3); border-left: 4px solid #8B0000; animation: slideIn 0.3s; }
        @keyframes slideIn { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .toast.success { border-left-color: #27ae60; }
        .toast.error { border-left-color: #e74c3c; }
        .toast.info { border-left-color: #3498db; }
    </style>
</head>
<body>
    <div class="loading" id="loading">
        <div class="spinner"></div>
        <div class="loading-text">Loading...</div>
    </div>
    
    <div class="toast-container" id="toastContainer"></div>
    
    <!-- Login Screen -->
    <div class="login-screen" id="loginScreen">
        <div class="login-container">
            <div class="login-header">
                <h1>üîß Change Requests</h1>
                <p class="subtitle">Management System - Phase 2</p>
            </div>
            <div class="login-box">
                <div class="error-message" id="loginError"></div>
                <form id="loginForm" onsubmit="return handleLogin(event)">
                    <div class="form-group">
                        <label for="usernameInput">Username</label>
                        <input type="text" id="usernameInput" placeholder="Enter your username" required>
                    </div>
                    <div class="form-group">
                        <label for="pinInput">PIN Code</label>
                        <input type="password" id="pinInput" placeholder="Enter your PIN" required maxlength="4" pattern="[0-9]{4}">
                    </div>
                    <button type="submit" class="btn-primary">Login</button>
                </form>
            </div>
        </div>
    </div>
    
    <!-- App Container -->
    <div class="app-container" id="appContainer">
        <div class="app-header">
            <div class="header-content">
                <div class="header-title">üîß Change Request Management</div>
                <div class="header-user">
                    <div class="user-info">
                        Logged in as: <span class="user-name" id="userName"></span>
                    </div>
                    <button class="btn-logout" onclick="handleLogout()">Logout</button>
                </div>
            </div>
        </div>
        
        <div class="nav-container">
            <div class="nav-tabs" id="navTabs"></div>
        </div>
        
        <div class="main-content" id="mainContent"></div>
    </div>
    
    <!-- Request Detail Modal -->
    <div class="modal" id="requestModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle">Request Details</div>
                <button class="modal-close" onclick="closeModal()">√ó</button>
            </div>
            <div class="modal-body" id="modalBody"></div>
        </div>
    </div>
    
    <!-- Advanced Search Modal -->
    <div class="modal" id="advancedSearchModal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <div class="modal-title">üîç Advanced Search</div>
                <button class="modal-close" onclick="closeAdvancedSearchModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="advanced-search-grid">
                    <div class="form-group">
                        <label>Search Term</label>
                        <input type="text" id="advSearchTerm" placeholder="Customer, truck, serial...">
                    </div>
                    <div class="form-group">
                        <label>Status</label>
                        <select id="advSearchStatus">
                            <option value="">All Statuses</option>
                            <option value="Sales Review">Sales Review</option>
                            <option value="Design Review">Design Review</option>
                            <option value="Shop Floor">Shop Floor</option>
                            <option value="Service Install">Service Install</option>
                            <option value="Complete">Complete</option>
                            <option value="Rejected">Rejected</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Priority</label>
                        <select id="advSearchPriority">
                            <option value="">All Priorities</option>
                            <option value="Normal">Normal</option>
                            <option value="Urgent">Urgent</option>
                            <option value="Critical">Critical</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Submitted By</label>
                        <input type="text" id="advSearchSubmittedBy" placeholder="Username">
                    </div>
                    <div class="form-group">
                        <label>Date From</label>
                        <input type="date" id="advSearchDateFrom">
                    </div>
                    <div class="form-group">
                        <label>Date To</label>
                        <input type="date" id="advSearchDateTo">
                    </div>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="btn-primary" onclick="performAdvancedSearch()">Search</button>
                    <button class="btn-clear" onclick="clearAdvancedSearch()">Clear</button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // UPDATE THIS WITH YOUR DEPLOYED WEB APP URL
        const API_URL = 'https://script.google.com/macros/s/AKfycbwzdBLg7l2rUL3XezF-We82hh9eTPHN7yMVR6xGkA4LNnOKlZ7w91ddMNKX6IZ2fhbCGg/exec';
        
        let currentUser = null;
        let currentRequests = [];
        let allRequests = [];
        let selectedRequest = null;
        let allUsers = [];
        let currentComments = [];
        let currentAttachments = [];
        let statusChart = null;
        let priorityChart = null;
        let trendChart = null;
        let stageTimeChart = null;
        
        // Filter state
        let filters = {
            search: '',
            dateRange: 'all'
        };
        
        function showLoading() { document.getElementById('loading').classList.add('active'); }
        function hideLoading() { document.getElementById('loading').classList.remove('active'); }
        
        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }
        
        async function apiCall(action, params = {}) {
            try {
                const url = new URL(API_URL);
                url.searchParams.append('action', action);
                url.searchParams.append('_t', Date.now());
                Object.keys(params).forEach(key => {
                    if (params[key] !== null && params[key] !== undefined) {
                        url.searchParams.append(key, params[key]);
                    }
                });
                console.log('API Call:', action, params);
                const response = await fetch(url.toString());
                if (!response.ok) {
                    console.error('Response not OK:', response.status, response.statusText);
                    throw new Error('Network error: ' + response.status);
                }
                const data = await response.json();
                console.log('API Response:', data);
                return data;
            } catch (error) {
                console.error('API Call Error:', error);
                throw error;
            }
        }
        
        async function handleLogin(event) {
            event.preventDefault();
            const username = document.getElementById('usernameInput').value;
            const pin = document.getElementById('pinInput').value;
            const errorDiv = document.getElementById('loginError');
            errorDiv.classList.remove('show');
            
            showLoading();
            try {
                const response = await apiCall('login', { username, pin });
                if (response.success) {
                    currentUser = response.data;
                    await loadAllUsers();
                    showApp();
                } else {
                    errorDiv.textContent = response.message || 'Invalid credentials';
                    errorDiv.classList.add('show');
                }
            } catch (error) {
                errorDiv.textContent = 'Connection error. Check internet and try again.';
                errorDiv.classList.add('show');
            } finally {
                hideLoading();
            }
            return false;
        }
        
        async function loadAllUsers() {
            try {
                const response = await apiCall('getAllUsers');
                if (response.success) {
                    allUsers = response.data;
                }
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }
        
        function showApp() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('appContainer').classList.add('active');
            document.getElementById('userName').textContent = currentUser.username;
            setupNavigation();
            loadDefaultView();
        }
        
        function setupNavigation() {
            const navTabs = document.getElementById('navTabs');
            navTabs.innerHTML = '';
            
            let tabs = [];
            if (currentUser.role === 'Sales Rep') {
                tabs = [
                    { id: 'myRequests', label: 'üìù My Requests' }
                ];
            } else if (currentUser.role === 'Management') {
                tabs = [
                    { id: 'allRequests', label: 'üìä All Requests' },
                    { id: 'analytics', label: 'üìà Analytics' },
                    { id: 'pendingApprovals', label: '‚è≥ Pending Approvals' }
                ];
            } else {
                tabs = [
                    { id: 'pendingApprovals', label: '‚è≥ Pending Approvals' },
                    { id: 'myRequests', label: 'üìù My Requests' }
                ];
            }
            
            tabs.forEach((tab, index) => {
                const button = document.createElement('button');
                button.className = 'nav-tab' + (index === 0 ? ' active' : '');
                button.textContent = tab.label;
                button.onclick = () => switchTab(tab.id, button);
                navTabs.appendChild(button);
            });
        }
        
        function switchTab(tabId, button) {
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            button.classList.add('active');
            
            switch(tabId) {
                case 'myRequests': loadMyRequests(); break;
                case 'pendingApprovals': loadPendingApprovals(); break;
                case 'allRequests': loadAllRequests(); break;
                case 'analytics': loadAnalytics(); break;
            }
        }
        
        function loadDefaultView() {
            if (currentUser.role === 'Sales Rep') {
                loadMyRequests();
            } else if (currentUser.role === 'Management') {
                loadAllRequests();
            } else {
                loadPendingApprovals();
            }
        }
        
        async function loadMyRequests() {
            showLoading();
            try {
                const response = await apiCall('getMyRequests', { username: currentUser.username });
                if (response.success) {
                    renderRequests(response.data, 'my');
                }
            } catch (error) {
                showToast('Error loading requests', 'error');
            } finally {
                hideLoading();
            }
        }
        
        async function loadPendingApprovals() {
            showLoading();
            try {
                const response = await apiCall('getPendingApprovals', { department: currentUser.department });
                if (response.success) {
                    renderRequests(response.data, 'pending');
                }
            } catch (error) {
                showToast('Error loading approvals', 'error');
            } finally {
                hideLoading();
            }
        }
        
        async function loadAllRequests() {
            showLoading();
            try {
                const response = await apiCall('getAllRequests');
                if (response.success) {
                    renderRequests(response.data, 'all');
                }
            } catch (error) {
                showToast('Error loading requests', 'error');
            } finally {
                hideLoading();
            }
        }
        
        // PHASE 2: Analytics Dashboard
        async function loadAnalytics() {
            showLoading();
            try {
                const response = await apiCall('getAnalytics');
                if (response.success) {
                    renderAnalyticsDashboard(response.data);
                }
            } catch (error) {
                showToast('Error loading analytics', 'error');
            } finally {
                hideLoading();
            }
        }
        
        function renderAnalyticsDashboard(analytics) {
            const content = document.getElementById('mainContent');
            
            let html = `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">üìä</div>
                        <div class="stat-label">Total Requests</div>
                        <div class="stat-value">${analytics.totalRequests}</div>
                        <div class="stat-subtitle">All time</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">‚è±Ô∏è</div>
                        <div class="stat-label">Avg Completion Time</div>
                        <div class="stat-value">${analytics.avgTimeToComplete}</div>
                        <div class="stat-subtitle">Days</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">‚úÖ</div>
                        <div class="stat-label">Completed</div>
                        <div class="stat-value">${analytics.byStatus['Complete'] || 0}</div>
                        <div class="stat-subtitle">${analytics.totalRequests > 0 ? Math.round((analytics.byStatus['Complete'] || 0)/analytics.totalRequests*100) : 0}% completion rate</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">‚è≥</div>
                        <div class="stat-label">In Progress</div>
                        <div class="stat-value">${Object.values(analytics.byStatus).reduce((a, b) => a + b, 0) - (analytics.byStatus['Complete'] || 0) - (analytics.byStatus['Rejected'] || 0)}</div>
                        <div class="stat-subtitle">Active requests</div>
                    </div>
                </div>
                
                <div class="charts-section">
                    <div class="chart-card">
                        <h3>üìä Requests by Status</h3>
                        <div class="chart-container">
                            <canvas id="statusChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <h3>‚ö° Requests by Priority</h3>
                        <div class="chart-container">
                            <canvas id="priorityChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="charts-section">
                    <div class="chart-card">
                        <h3>üìà Requests Over Time</h3>
                        <div class="chart-container">
                            <canvas id="trendChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <h3>‚è±Ô∏è Average Time by Stage</h3>
                        <div class="chart-container">
                            <canvas id="stageTimeChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="analytics-section">
                    <div class="analytics-card">
                        <h4>Status Breakdown</h4>
            `;
            
            for (let status in analytics.byStatus) {
                html += `
                    <div class="metric-row">
                        <div class="metric-label">${status}</div>
                        <div class="metric-value">${analytics.byStatus[status]}</div>
                    </div>
                `;
            }
            
            html += `
                    </div>
                    <div class="analytics-card">
                        <h4>Priority Breakdown</h4>
            `;
            
            for (let priority in analytics.byPriority) {
                html += `
                    <div class="metric-row">
                        <div class="metric-label">${priority}</div>
                        <div class="metric-value">${analytics.byPriority[priority]}</div>
                    </div>
                `;
            }
            
            html += `
                    </div>
                    <div class="analytics-card">
                        <h4>Average Stage Duration (Days)</h4>
            `;
            
            for (let stage in analytics.avgTimeByStage) {
                html += `
                    <div class="metric-row">
                        <div class="metric-label">${stage}</div>
                        <div class="metric-value">${Math.round(analytics.avgTimeByStage[stage] * 10) / 10}</div>
                    </div>
                `;
            }
            
            html += `
                    </div>
                </div>
            `;
            
            content.innerHTML = html;
            
            setTimeout(() => {
                initializeAnalyticsCharts(analytics);
            }, 100);
        }
        
        function initializeAnalyticsCharts(analytics) {
            // Status Chart
            if (statusChart) statusChart.destroy();
            const statusCtx = document.getElementById('statusChart');
            if (statusCtx) {
                const labels = Object.keys(analytics.byStatus);
                const data = Object.values(analytics.byStatus);
                statusChart = new Chart(statusCtx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: ['#3498db', '#9b59b6', '#e67e22', '#1abc9c', '#27ae60', '#e74c3c'],
                            borderWidth: 2,
                            borderColor: '#1a1a1a'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                labels: {
                                    color: '#ffffff',
                                    font: { size: 12 }
                                }
                            }
                        }
                    }
                });
            }
            
            // Priority Chart
            if (priorityChart) priorityChart.destroy();
            const priorityCtx = document.getElementById('priorityChart');
            if (priorityCtx) {
                const labels = Object.keys(analytics.byPriority);
                const data = Object.values(analytics.byPriority);
                priorityChart = new Chart(priorityCtx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Requests',
                            data: data,
                            backgroundColor: ['#3498db', '#f39c12', '#e74c3c'],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { color: '#ffffff', stepSize: 1 },
                                grid: { color: '#3d3d3d' }
                            },
                            x: {
                                ticks: { color: '#ffffff' },
                                grid: { display: false }
                            }
                        },
                        plugins: { legend: { display: false } }
                    }
                });
            }
            
            // Trend Chart
            if (trendChart) trendChart.destroy();
            const trendCtx = document.getElementById('trendChart');
            if (trendCtx && analytics.requestsOverTime.length > 0) {
                const labels = analytics.requestsOverTime.map(d => d.month);
                const data = analytics.requestsOverTime.map(d => d.count);
                trendChart = new Chart(trendCtx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Requests',
                            data: data,
                            borderColor: '#8B0000',
                            backgroundColor: 'rgba(139, 0, 0, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { color: '#ffffff', stepSize: 1 },
                                grid: { color: '#3d3d3d' }
                            },
                            x: {
                                ticks: { color: '#ffffff' },
                                grid: { display: false }
                            }
                        },
                        plugins: {
                            legend: {
                                labels: { color: '#ffffff' }
                            }
                        }
                    }
                });
            }
            
            // Stage Time Chart
            if (stageTimeChart) stageTimeChart.destroy();
            const stageTimeCtx = document.getElementById('stageTimeChart');
            if (stageTimeCtx) {
                const labels = Object.keys(analytics.avgTimeByStage);
                const data = Object.values(analytics.avgTimeByStage).map(v => Math.round(v * 10) / 10);
                stageTimeChart = new Chart(stageTimeCtx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Days',
                            data: data,
                            backgroundColor: '#8B0000',
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        indexAxis: 'y',
                        scales: {
                            x: {
                                beginAtZero: true,
                                ticks: { color: '#ffffff' },
                                grid: { color: '#3d3d3d' }
                            },
                            y: {
                                ticks: { color: '#ffffff' },
                                grid: { display: false }
                            }
                        },
                        plugins: {
                            legend: { display: false }
                        }
                    }
                });
            }
        }
        
        function renderRequests(requests, viewType) {
            allRequests = requests;
            currentRequests = requests;
            applyFilters(viewType);
        }
        
        function applyFilters(viewType) {
            let filtered = [...allRequests];
            
            if (filters.search) {
                const searchLower = filters.search.toLowerCase();
                filtered = filtered.filter(req => 
                    req.requestID.toLowerCase().includes(searchLower) ||
                    req.customerName.toLowerCase().includes(searchLower) ||
                    req.truckModel.toLowerCase().includes(searchLower) ||
                    (req.submittedBy && req.submittedBy.toLowerCase().includes(searchLower))
                );
            }
            
            if (filters.dateRange !== 'all') {
                const now = new Date();
                let startDate;
                
                switch(filters.dateRange) {
                    case 'today':
                        startDate = new Date(now.setHours(0,0,0,0));
                        break;
                    case 'week':
                        startDate = new Date(now.setDate(now.getDate() - 7));
                        break;
                    case 'month':
                        startDate = new Date(now.setMonth(now.getMonth() - 1));
                        break;
                }
                
                filtered = filtered.filter(req => new Date(req.dateSubmitted) >= startDate);
            }
            
            currentRequests = filtered;
            renderDashboard(filtered, viewType);
        }
        
        function renderDashboard(requests, viewType) {
            const content = document.getElementById('mainContent');
            
            let html = buildStatsCards(requests) + buildFiltersSection() + buildChartsSection();
            
            if (requests.length === 0) {
                html += '<div class="empty-state"><div class="empty-state-icon">üìã</div><div class="empty-state-text">No requests found</div></div>';
            } else {
                html += '<div class="requests-grid">';
                requests.forEach(req => {
                    const statusClass = getStatusClass(req.status);
                    const priorityClass = getPriorityClass(req.priority);
                    
                    html += `
                        <div class="request-card" onclick="viewRequestDetails('${req.requestID}')">
                            <div class="request-header">
                                <div>
                                    <div class="request-id">${req.requestID}</div>
                                    <div class="request-date">${formatDate(req.dateSubmitted)}</div>
                                </div>
                                <span class="status-badge ${statusClass}">${req.currentStage}</span>
                            </div>
                            <div class="request-info">
                                <div class="info-row">
                                    <span class="info-label">Customer:</span>
                                    <span class="info-value">${req.customerName}</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">Truck Model:</span>
                                    <span class="info-value">${req.truckModel}</span>
                                </div>
                                ${viewType !== 'my' ? `
                                <div class="info-row">
                                    <span class="info-label">Submitted By:</span>
                                    <span class="info-value">${req.submittedBy}</span>
                                </div>
                                ` : ''}
                                <div class="info-row">
                                    <span class="info-label">Priority:</span>
                                    <span class="priority-badge ${priorityClass}">${req.priority}</span>
                                </div>
                            </div>
                            ${viewType === 'pending' ? `
                            <div class="request-actions">
                                <button class="btn-approve" onclick="event.stopPropagation(); approveRequest('${req.requestID}')">‚úì Approve</button>
                                <button class="btn-reject" onclick="event.stopPropagation(); rejectRequest('${req.requestID}')">‚úï Reject</button>
                            </div>
                            ` : ''}
                        </div>
                    `;
                });
                html += '</div>';
            }
            
            content.innerHTML = html;
            setTimeout(() => { initializeCharts(requests); attachFilterListeners(); }, 100);
        }
        
        function buildStatsCards(requests) {
            const total = requests.length;
            const pending = requests.filter(r => !r.currentStage.includes('Complete') && !r.currentStage.includes('Rejected')).length;
            const complete = requests.filter(r => r.currentStage.includes('Complete')).length;
            const rejected = requests.filter(r => r.currentStage.includes('Rejected')).length;
            
            return `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">üìä</div>
                        <div class="stat-label">Total Requests</div>
                        <div class="stat-value">${total}</div>
                        <div class="stat-subtitle">All time</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">‚è≥</div>
                        <div class="stat-label">In Progress</div>
                        <div class="stat-value">${pending}</div>
                        <div class="stat-subtitle">Awaiting approval</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">‚úÖ</div>
                        <div class="stat-label">Completed</div>
                        <div class="stat-value">${complete}</div>
                        <div class="stat-subtitle">${total > 0 ? Math.round((complete/total)*100) : 0}% completion rate</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">‚ùå</div>
                        <div class="stat-label">Rejected</div>
                        <div class="stat-value">${rejected}</div>
                        <div class="stat-subtitle">${total > 0 ? Math.round((rejected/total)*100) : 0}% rejection rate</div>
                    </div>
                </div>
            `;
        }
        
        function buildFiltersSection() {
            return `
                <div class="filters-section">
                    <div class="filters-header">
                        <div class="filters-title">üîç Filters</div>
                        <button class="btn-advanced-search" onclick="openAdvancedSearchModal()">Advanced Search</button>
                    </div>
                    <div class="filters-grid">
                        <div class="filter-group">
                            <label>üîç Quick Search</label>
                            <input type="text" id="searchInput" placeholder="Search by customer, ID, truck model..." value="${filters.search}">
                        </div>
                        <div class="filter-group">
                            <label>üìÖ Date Range</label>
                            <select id="dateRangeSelect">
                                <option value="all" ${filters.dateRange === 'all' ? 'selected' : ''}>All Time</option>
                                <option value="today" ${filters.dateRange === 'today' ? 'selected' : ''}>Today</option>
                                <option value="week" ${filters.dateRange === 'week' ? 'selected' : ''}>This Week</option>
                                <option value="month" ${filters.dateRange === 'month' ? 'selected' : ''}>This Month</option>
                            </select>
                        </div>
                        <button class="btn-filter" onclick="handleFilterApply()">Apply</button>
                        <button class="btn-clear" onclick="handleFilterClear()">Clear</button>
                    </div>
                </div>
            `;
        }
        
        function buildChartsSection() {
            return `
                <div class="charts-section">
                    <div class="chart-card">
                        <h3>üìä Requests by Status</h3>
                        <div class="chart-container">
                            <canvas id="statusChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <h3>‚ö° Requests by Priority</h3>
                        <div class="chart-container">
                            <canvas id="priorityChart"></canvas>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function initializeCharts(requests) {
            if (statusChart) statusChart.destroy();
            if (priorityChart) priorityChart.destroy();
            
            const statusCounts = { 'Sales Review': 0, 'Design Review': 0, 'Shop Floor': 0, 'Service Install': 0, 'Complete': 0, 'Rejected': 0 };
            requests.forEach(req => {
                if (req.currentStage.includes('Sales')) statusCounts['Sales Review']++;
                else if (req.currentStage.includes('Design')) statusCounts['Design Review']++;
                else if (req.currentStage.includes('Shop')) statusCounts['Shop Floor']++;
                else if (req.currentStage.includes('Service')) statusCounts['Service Install']++;
                else if (req.currentStage.includes('Complete')) statusCounts['Complete']++;
                else if (req.currentStage.includes('Rejected')) statusCounts['Rejected']++;
            });
            
            const statusCtx = document.getElementById('statusChart');
            if (statusCtx) {
                statusChart = new Chart(statusCtx, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(statusCounts),
                        datasets: [{ data: Object.values(statusCounts), backgroundColor: ['#3498db', '#9b59b6', '#e67e22', '#1abc9c', '#27ae60', '#e74c3c'], borderWidth: 2, borderColor: '#1a1a1a' }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { labels: { color: '#ffffff', font: { size: 12 } } } } }
                });
            }
            
            const priorityCounts = { 'Normal': 0, 'Urgent': 0, 'Critical': 0 };
            requests.forEach(req => { if (priorityCounts[req.priority] !== undefined) priorityCounts[req.priority]++; });
            
            const priorityCtx = document.getElementById('priorityChart');
            if (priorityCtx) {
                priorityChart = new Chart(priorityCtx, {
                    type: 'bar',
                    data: {
                        labels: Object.keys(priorityCounts),
                        datasets: [{ label: 'Requests', data: Object.values(priorityCounts), backgroundColor: ['#3498db', '#f39c12', '#e74c3c'], borderWidth: 0 }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { color: '#ffffff', stepSize: 1 }, grid: { color: '#3d3d3d' } }, x: { ticks: { color: '#ffffff' }, grid: { display: false } } }, plugins: { legend: { display: false } } }
                });
            }
        }
        
        function attachFilterListeners() {
            const searchInput = document.getElementById('searchInput');
            if (searchInput) { searchInput.addEventListener('keyup', (e) => { if (e.key === 'Enter') handleFilterApply(); }); }
        }
        
        function handleFilterApply() {
            const searchInput = document.getElementById('searchInput');
            const dateRangeSelect = document.getElementById('dateRangeSelect');
            if (searchInput) filters.search = searchInput.value;
            if (dateRangeSelect) filters.dateRange = dateRangeSelect.value;
            let viewType = 'my';
            const activeTab = document.querySelector('.nav-tab.active');
            if (activeTab) {
                if (activeTab.textContent.includes('All')) viewType = 'all';
                else if (activeTab.textContent.includes('Pending')) viewType = 'pending';
            }
            applyFilters(viewType);
            showToast('Filters applied!', 'success');
        }
        
        function handleFilterClear() {
            filters = { search: '', dateRange: 'all' };
            let viewType = 'my';
            const activeTab = document.querySelector('.nav-tab.active');
            if (activeTab) {
                if (activeTab.textContent.includes('All')) viewType = 'all';
                else if (activeTab.textContent.includes('Pending')) viewType = 'pending';
            }
            applyFilters(viewType);
            showToast('Filters cleared', 'info');
        }
        
        // PHASE 2: Advanced Search
        function openAdvancedSearchModal() {
            document.getElementById('advancedSearchModal').classList.add('active');
        }
        
        function closeAdvancedSearchModal() {
            document.getElementById('advancedSearchModal').classList.remove('active');
        }
        
        async function performAdvancedSearch() {
            const searchParams = {
                searchTerm: document.getElementById('advSearchTerm').value,
                status: document.getElementById('advSearchStatus').value,
                priority: document.getElementById('advSearchPriority').value,
                submittedBy: document.getElementById('advSearchSubmittedBy').value,
                dateFrom: document.getElementById('advSearchDateFrom').value,
                dateTo: document.getElementById('advSearchDateTo').value
            };
            
            showLoading();
            closeAdvancedSearchModal();
            
            try {
                const response = await apiCall('advancedSearch', searchParams);
                if (response.success) {
                    allRequests = response.data;
                    currentRequests = response.data;
                    renderDashboard(response.data, 'all');
                    showToast(`Found ${response.data.length} results`, 'success');
                }
            } catch (error) {
                showToast('Search error', 'error');
            } finally {
                hideLoading();
            }
        }
        
        function clearAdvancedSearch() {
            document.getElementById('advSearchTerm').value = '';
            document.getElementById('advSearchStatus').value = '';
            document.getElementById('advSearchPriority').value = '';
            document.getElementById('advSearchSubmittedBy').value = '';
            document.getElementById('advSearchDateFrom').value = '';
            document.getElementById('advSearchDateTo').value = '';
        }
        
        // PHASE 2: View Request Details with Comments & Attachments
        async function viewRequestDetails(requestID) {
            showLoading();
            try {
                const response = await apiCall('getRequestDetails', { requestID });
                if (response.success) {
                    selectedRequest = response.data;
                    await loadComments(requestID);
                    await loadAttachments(requestID);
                    showRequestModal();
                }
            } catch (error) {
                showToast('Error loading details', 'error');
            } finally {
                hideLoading();
            }
        }
        
        async function loadComments(requestID) {
            try {
                const response = await apiCall('getComments', { requestID });
                if (response.success) {
                    currentComments = response.data;
                }
            } catch (error) {
                console.error('Error loading comments:', error);
                currentComments = [];
            }
        }
        
        async function loadAttachments(requestID) {
            try {
                const response = await apiCall('getFiles', { requestID });
                if (response.success) {
                    currentAttachments = response.data;
                }
            } catch (error) {
                console.error('Error loading attachments:', error);
                currentAttachments = [];
            }
        }
        
        function showRequestModal() {
            const req = selectedRequest;
            const modal = document.getElementById('requestModal');
            const modalBody = document.getElementById('modalBody');
            
            document.getElementById('modalTitle').textContent = req.requestID;
            
            let html = `
                <div class="detail-section">
                    <h3>Customer Information</h3>
                    <div class="detail-grid">
                        <div class="detail-row">
                            <div class="detail-label">Customer Name:</div>
                            <div class="detail-value">${req.customerName}</div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">Address:</div>
                            <div class="detail-value">${req.customerAddress}</div>
                        </div>
                    </div>
                </div>
                
                <div class="detail-section">
                    <h3>Truck Information</h3>
                    <div class="detail-grid">
                        <div class="detail-row">
                            <div class="detail-label">Model:</div>
                            <div class="detail-value">${req.truckModel}</div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">Serial Number:</div>
                            <div class="detail-value">${req.serialNumber}</div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">Specification:</div>
                            <div class="detail-value">${req.specification}</div>
                        </div>
                    </div>
                </div>
                
                <div class="detail-section">
                    <h3>Request Details</h3>
                    <div class="detail-grid">
                        <div class="detail-row">
                            <div class="detail-label">Priority:</div>
                            <div class="detail-value"><span class="priority-badge ${getPriorityClass(req.priority)}">${req.priority}</span></div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">Status:</div>
                            <div class="detail-value"><span class="status-badge ${getStatusClass(req.status)}">${req.currentStage}</span></div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">Submitted By:</div>
                            <div class="detail-value">${req.submittedBy}</div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">Date Submitted:</div>
                            <div class="detail-value">${formatDate(req.dateSubmitted)}</div>
                        </div>
                    </div>
                </div>
                
                <div class="detail-section">
                    <h3>Approval Timeline</h3>
                    <div class="timeline">
            `;
            
            // Timeline items
            if (req.salesApproved) {
                html += `
                    <div class="timeline-item">
                        <div class="timeline-stage">Sales Department ${req.salesApproved === 'Yes' ? '‚úì Approved' : '‚úó Rejected'}</div>
                        <div class="timeline-user">By ${req.salesApprovedBy}</div>
                        <div class="timeline-date">${formatDate(req.salesApprovedDate)}</div>
                        ${req.salesComments ? `<div class="timeline-comments">${req.salesComments}</div>` : ''}
                    </div>
                `;
            }
            
            if (req.designApproved) {
                html += `
                    <div class="timeline-item">
                        <div class="timeline-stage">Design Department ${req.designApproved === 'Yes' ? '‚úì Approved' : '‚úó Rejected'}</div>
                        <div class="timeline-user">By ${req.designApprovedBy}</div>
                        <div class="timeline-date">${formatDate(req.designApprovedDate)}</div>
                        ${req.designComments ? `<div class="timeline-comments">${req.designComments}</div>` : ''}
                        ${req.workInstructionPDF ? `<div class="timeline-comments">üìÑ Work Instruction: ${req.workInstructionPDF}</div>` : ''}
                    </div>
                `;
            }
            
            if (req.shopFloorComplete) {
                html += `
                    <div class="timeline-item">
                        <div class="timeline-stage">Shop Floor ‚úì Complete</div>
                        <div class="timeline-user">By ${req.shopFloorCompleteBy}</div>
                        <div class="timeline-date">${formatDate(req.shopFloorCompleteDate)}</div>
                        ${req.shopFloorComments ? `<div class="timeline-comments">${req.shopFloorComments}</div>` : ''}
                    </div>
                `;
            }
            
            if (req.serviceComplete) {
                html += `
                    <div class="timeline-item">
                        <div class="timeline-stage">Service ‚úì Complete</div>
                        <div class="timeline-user">By ${req.serviceCompleteBy}</div>
                        <div class="timeline-date">${formatDate(req.serviceCompleteDate)}</div>
                        ${req.serviceComments ? `<div class="timeline-comments">${req.serviceComments}</div>` : ''}
                    </div>
                `;
            }
            
            html += `
                    </div>
                </div>
            `;
            
            // PHASE 2: Comments Section
            html += buildCommentsSection();
            
            // PHASE 2: Attachments Section
            html += buildAttachmentsSection();
            
            // Action buttons
            const canAction = canUserAction(req);
            if (canAction) {
                html += `
                    <div class="comment-box">
                        <label style="color: #e0e0e0; font-weight: 600; margin-bottom: 8px; display: block;">Add Comments:</label>
                        <textarea id="modalComments" placeholder="Enter your comments..."></textarea>
                    </div>
                    <div class="modal-actions">
                        <button class="btn-modal-approve" onclick="confirmApprove()">‚úì Approve & Progress</button>
                        <button class="btn-modal-reject" onclick="confirmReject()">‚úï Reject Request</button>
                        <button class="btn-modal-close" onclick="closeModal()">Close</button>
                    </div>
                `;
            } else {
                html += `
                    <div class="modal-actions">
                        <button class="btn-modal-close" onclick="closeModal()">Close</button>
                    </div>
                `;
            }
            
            modalBody.innerHTML = html;
            modal.classList.add('active');
            
            // Attach comment input listener for @mentions
            const commentInput = document.getElementById('commentInput');
            if (commentInput) {
                commentInput.addEventListener('input', handleCommentInput);
                commentInput.addEventListener('keydown', handleCommentKeydown);
            }
        }
        
        function buildCommentsSection() {
            let html = `
                <div class="comments-section">
                    <div class="comments-header">
                        <div class="comments-title">üí¨ Comments</div>
                        <div class="comments-count">${currentComments.length} ${currentComments.length === 1 ? 'comment' : 'comments'}</div>
                    </div>
            `;
            
            if (currentComments.length > 0) {
                html += '<div class="comment-thread">';
                currentComments.forEach(comment => {
                    html += `
                        <div class="comment-item">
                            <div class="comment-header">
                                <div>
                                    <span class="comment-user">${comment.user}</span>
                                    ${comment.edited === 'Yes' ? '<span class="comment-edited">(edited)</span>' : ''}
                                </div>
                                <span class="comment-time">${formatDate(comment.timestamp)}</span>
                            </div>
                            <div class="comment-text">${highlightMentions(comment.comment)}</div>
                            ${comment.user === currentUser.username ? `
                            <div class="comment-actions">
                                <button class="btn-comment-action" onclick="editComment('${comment.commentID}', \`${comment.comment.replace(/`/g, '\\`')}\`)">Edit</button>
                                <button class="btn-comment-action" onclick="deleteComment('${comment.commentID}')">Delete</button>
                            </div>
                            ` : ''}
                        </div>
                    `;
                });
                html += '</div>';
            }
            
            html += `
                <div class="comment-input-box">
                    <textarea id="commentInput" class="comment-input" placeholder="Add a comment... (Type @ to mention someone)"></textarea>
                    <div id="mentionDropdown" class="mention-dropdown"></div>
                    <button class="btn-add-comment" onclick="addComment()">Post Comment</button>
                </div>
                </div>
            `;
            
            return html;
        }
        
        function buildAttachmentsSection() {
            let html = `
                <div class="attachments-section">
                    <div class="attachments-header">
                        <div class="attachments-title">üìé Attachments</div>
                        <button class="btn-upload-file" onclick="document.getElementById('fileUploadInput').click()">Upload File</button>
                        <input type="file" id="fileUploadInput" class="file-input-hidden" onchange="handleFileUpload(event)" accept="image/*,.pdf,.docx,.xlsx">
                    </div>
            `;
            
            if (currentAttachments.length > 0) {
                html += '<div class="attachments-grid">';
                currentAttachments.forEach(file => {
                    const isImage = file.mimeType && file.mimeType.startsWith('image/');
                    html += `
                        <div class="attachment-item" onclick="window.open('${file.fileURL}', '_blank')">
                            ${isImage ? `<img src="${file.fileURL}" class="attachment-image" alt="${file.filename}">` : `<div class="attachment-icon">üìÑ</div>`}
                            <div class="attachment-name">${file.filename}</div>
                            <div class="attachment-meta">${file.uploadedBy}</div>
                        </div>
                    `;
                });
                html += '</div>';
            } else {
                html += '<p style="color: #b0b0b0; text-align: center; padding: 20px;">No attachments yet</p>';
            }
            
            html += '</div>';
            return html;
        }
        
        function highlightMentions(text) {
            return text.replace(/@(\w+)/g, '<span class="comment-mention">@$1</span>');
        }
        
        // PHASE 2: @Mention Handling
        let mentionSearchActive = false;
        let mentionStartPos = 0;
        let selectedMentionIndex = 0;
        
        function handleCommentInput(e) {
            const input = e.target;
            const text = input.value;
            const cursorPos = input.selectionStart;
            
            // Check if @ was just typed
            const textBeforeCursor = text.substring(0, cursorPos);
            const lastAtPos = textBeforeCursor.lastIndexOf('@');
            
            if (lastAtPos !== -1 && cursorPos - lastAtPos <= 20) {
                const searchTerm = textBeforeCursor.substring(lastAtPos + 1);
                if (searchTerm.match(/^\w*$/)) {
                    mentionSearchActive = true;
                    mentionStartPos = lastAtPos;
                    showMentionDropdown(searchTerm, input);
                    return;
                }
            }
            
            // Hide dropdown if @ not found nearby
            if (mentionSearchActive && lastAtPos === -1) {
                hideMentionDropdown();
            }
        }
        
        function showMentionDropdown(searchTerm, input) {
            const dropdown = document.getElementById('mentionDropdown');
            if (!dropdown) return;
            
            const filtered = allUsers.filter(user => 
                user.username.toLowerCase().startsWith(searchTerm.toLowerCase())
            );
            
            if (filtered.length === 0) {
                hideMentionDropdown();
                return;
            }
            
            let html = '';
            filtered.forEach((user, index) => {
                html += `
                    <div class="mention-item ${index === 0 ? 'selected' : ''}" onclick="selectMention('${user.username}')">
                        <div class="mention-name">@${user.username}</div>
                        <div class="mention-dept">${user.department} - ${user.role}</div>
                    </div>
                `;
            });
            
            dropdown.innerHTML = html;
            dropdown.classList.add('active');
            
            // Position dropdown below cursor
            const rect = input.getBoundingClientRect();
            dropdown.style.left = rect.left + 'px';
            dropdown.style.top = (rect.bottom + 5) + 'px';
            dropdown.style.width = '250px';
            
            selectedMentionIndex = 0;
        }
        
        function hideMentionDropdown() {
            const dropdown = document.getElementById('mentionDropdown');
            if (dropdown) {
                dropdown.classList.remove('active');
                mentionSearchActive = false;
            }
        }
        
        function handleCommentKeydown(e) {
            if (!mentionSearchActive) return;
            
            const dropdown = document.getElementById('mentionDropdown');
            if (!dropdown || !dropdown.classList.contains('active')) return;
            
            const items = dropdown.querySelectorAll('.mention-item');
            
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                selectedMentionIndex = (selectedMentionIndex + 1) % items.length;
                updateMentionSelection(items);
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                selectedMentionIndex = (selectedMentionIndex - 1 + items.length) % items.length;
                updateMentionSelection(items);
            } else if (e.key === 'Enter' || e.key === 'Tab') {
                e.preventDefault();
                const selected = items[selectedMentionIndex];
                if (selected) {
                    const username = selected.querySelector('.mention-name').textContent.substring(1);
                    selectMention(username);
                }
            } else if (e.key === 'Escape') {
                hideMentionDropdown();
            }
        }
        
        function updateMentionSelection(items) {
            items.forEach((item, index) => {
                item.classList.toggle('selected', index === selectedMentionIndex);
            });
        }
        
        function selectMention(username) {
            const input = document.getElementById('commentInput');
            if (!input) return;
            
            const text = input.value;
            const newText = text.substring(0, mentionStartPos) + '@' + username + ' ' + text.substring(input.selectionStart);
            input.value = newText;
            
            const newPos = mentionStartPos + username.length + 2;
            input.setSelectionRange(newPos, newPos);
            input.focus();
            
            hideMentionDropdown();
        }
        
        // PHASE 2: Add Comment
        async function addComment() {
            const commentInput = document.getElementById('commentInput');
            if (!commentInput) return;
            
            const comment = commentInput.value.trim();
            if (!comment) {
                showToast('Please enter a comment', 'error');
                return;
            }
            
            // Extract mentions
            const mentionMatches = comment.match(/@(\w+)/g);
            const mentions = mentionMatches ? mentionMatches.map(m => m.substring(1)).join(',') : '';
            
            showLoading();
            try {
                const response = await apiCall('addComment', {
                    requestID: selectedRequest.requestID,
                    username: currentUser.username,
                    comment: comment,
                    mentions: mentions
                });
                
                if (response.success) {
                    showToast('Comment added!', 'success');
                    commentInput.value = '';
                    await loadComments(selectedRequest.requestID);
                    showRequestModal(); // Refresh modal
                }
            } catch (error) {
                showToast('Error adding comment', 'error');
            } finally {
                hideLoading();
            }
        }
        
        async function editComment(commentID, currentText) {
            const newText = prompt('Edit comment:', currentText);
            if (!newText || newText === currentText) return;
            
            showLoading();
            try {
                const response = await apiCall('editComment', {
                    commentID: commentID,
                    newComment: newText,
                    username: currentUser.username
                });
                
                if (response.success) {
                    showToast('Comment updated!', 'success');
                    await loadComments(selectedRequest.requestID);
                    showRequestModal();
                }
            } catch (error) {
                showToast('Error updating comment', 'error');
            } finally {
                hideLoading();
            }
        }
        
        async function deleteComment(commentID) {
            if (!confirm('Delete this comment?')) return;
            
            showLoading();
            try {
                const response = await apiCall('deleteComment', {
                    commentID: commentID,
                    username: currentUser.username
                });
                
                if (response.success) {
                    showToast('Comment deleted', 'info');
                    await loadComments(selectedRequest.requestID);
                    showRequestModal();
                }
            } catch (error) {
                showToast('Error deleting comment', 'error');
            } finally {
                hideLoading();
            }
        }
        
        // PHASE 2: File Upload
        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (file.size > 5 * 1024 * 1024) {
                showToast('File too large (max 5MB)', 'error');
                return;
            }
            
            showLoading();
            try {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    const base64 = e.target.result.split(',')[1];
                    
                    const response = await apiCall('uploadFile', {
                        requestID: selectedRequest.requestID,
                        filename: file.name,
                        fileData: base64,
                        mimeType: file.type,
                        uploadedBy: currentUser.username
                    });
                    
                    if (response.success) {
                        showToast('File uploaded!', 'success');
                        await loadAttachments(selectedRequest.requestID);
                        showRequestModal();
                    }
                    hideLoading();
                };
                reader.readAsDataURL(file);
            } catch (error) {
                showToast('Error uploading file', 'error');
                hideLoading();
            }
        }
        
        function canUserAction(req) {
            if (currentUser.department === 'Sales' && req.currentStage === 'Sales Review') return true;
            if (currentUser.department === 'Design' && req.currentStage === 'Design Review') return true;
            if (currentUser.department === 'Shop Floor' && req.currentStage === 'Shop Floor') return true;
            if (currentUser.department === 'Service' && req.currentStage === 'Service Install') return true;
            return false;
        }
        
        function closeModal() {
            document.getElementById('requestModal').classList.remove('active');
            selectedRequest = null;
            currentComments = [];
            currentAttachments = [];
        }
        
        async function confirmApprove() {
            const comments = document.getElementById('modalComments').value;
            
            if (!confirm('Are you sure you want to approve this request?')) return;
            
            const requestID = selectedRequest.requestID;
            const department = currentUser.department;
            const approvedBy = currentUser.username;
            
            showLoading();
            closeModal();
            
            try {
                const response = await apiCall('approveRequest', {
                    requestID: requestID,
                    department: department,
                    approvedBy: approvedBy,
                    comments: comments
                });
                
                if (response.success) {
                    showToast('Request approved successfully!', 'success');
                    loadPendingApprovals();
                } else {
                    showToast('Error approving request: ' + response.message, 'error');
                }
            } catch (error) {
                showToast('Connection error: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }
        
        async function confirmReject() {
            const comments = document.getElementById('modalComments').value;
            
            if (!comments.trim()) {
                alert('Please provide a reason for rejection');
                return;
            }
            
            if (!confirm('Are you sure you want to reject this request?')) return;
            
            const requestID = selectedRequest.requestID;
            const department = currentUser.department;
            const rejectedBy = currentUser.username;
            
            showLoading();
            closeModal();
            
            try {
                const response = await apiCall('rejectRequest', {
                    requestID: requestID,
                    department: department,
                    rejectedBy: rejectedBy,
                    reason: comments
                });
                
                if (response.success) {
                    showToast('Request rejected', 'info');
                    loadPendingApprovals();
                } else {
                    showToast('Error rejecting request', 'error');
                }
            } catch (error) {
                showToast('Connection error', 'error');
            } finally {
                hideLoading();
            }
        }
        
        function approveRequest(requestID) {
            viewRequestDetails(requestID);
        }
        
        function rejectRequest(requestID) {
            viewRequestDetails(requestID);
        }
        
        function getStatusClass(status) {
            if (!status) return 'status-submitted';
            if (status.includes('Sales')) return 'status-sales';
            if (status.includes('Design')) return 'status-design';
            if (status.includes('Shop')) return 'status-shopfloor';
            if (status.includes('Service')) return 'status-service';
            if (status.includes('Complete')) return 'status-complete';
            if (status.includes('Rejected')) return 'status-rejected';
            return 'status-submitted';
        }
        
        function getPriorityClass(priority) {
            if (priority === 'Critical') return 'priority-critical';
            if (priority === 'Urgent') return 'priority-urgent';
            return 'priority-normal';
        }
        
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleString('en-GB', { 
                day: '2-digit', 
                month: 'short', 
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        function handleLogout() {
            if (confirm('Are you sure you want to logout?')) {
                currentUser = null;
                currentRequests = [];
                allUsers = [];
                document.getElementById('appContainer').classList.remove('active');
                document.getElementById('loginScreen').classList.remove('hidden');
                document.getElementById('loginForm').reset();
            }
        }
        
        console.log('üîß Change Request Management System - Phase 2 Ready!');
    </script>
</body>
</html>
